# --------------------------------------------------------
# PersistentVolumeClaims (uses default StorageClass)
# --------------------------------------------------------
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: users-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: appointments-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: billing-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: doctors-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi

# --------------------------------------------------------
# Postgres Deployments + Services
# (users, appointments, billing, doctors)
# --------------------------------------------------------
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-users
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-users
  template:
    metadata:
      labels:
        app: postgres-users
    spec:
      containers:
      - name: postgres
        image: postgres:15
        env:
        - name: POSTGRES_USER
          value: "hms"
        - name: POSTGRES_PASSWORD
          value: "hms123"
        - name: POSTGRES_DB
          value: "users_db"
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: users-data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: users-data
        persistentVolumeClaim:
          claimName: users-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-users
spec:
  ports:
  - port: 5432
    targetPort: 5432
  selector:
    app: postgres-users
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-appointments
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-appointments
  template:
    metadata:
      labels:
        app: postgres-appointments
    spec:
      containers:
      - name: postgres
        image: postgres:15
        env:
        - name: POSTGRES_USER
          value: "hms"
        - name: POSTGRES_PASSWORD
          value: "hms123"
        - name: POSTGRES_DB
          value: "appointments_db"
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: appointments-data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: appointments-data
        persistentVolumeClaim:
          claimName: appointments-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-appointments
spec:
  ports:
  - port: 5432
    targetPort: 5432
  selector:
    app: postgres-appointments
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-billing
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-billing
  template:
    metadata:
      labels:
        app: postgres-billing
    spec:
      containers:
      - name: postgres
        image: postgres:15
        env:
        - name: POSTGRES_USER
          value: "hms"
        - name: POSTGRES_PASSWORD
          value: "hms123"
        - name: POSTGRES_DB
          value: "billing_db"
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: billing-data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: billing-data
        persistentVolumeClaim:
          claimName: billing-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-billing
spec:
  ports:
  - port: 5432
    targetPort: 5432
  selector:
    app: postgres-billing
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-doctors
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-doctors
  template:
    metadata:
      labels:
        app: postgres-doctors
    spec:
      containers:
      - name: postgres
        image: postgres:15
        env:
        - name: POSTGRES_USER
          value: "hms"
        - name: POSTGRES_PASSWORD
          value: "hms123"
        - name: POSTGRES_DB
          value: "doctors_db"
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: doctors-data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: doctors-data
        persistentVolumeClaim:
          claimName: doctors-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-doctors
spec:
  ports:
  - port: 5432
    targetPort: 5432
  selector:
    app: postgres-doctors
  type: ClusterIP

# --------------------------------------------------------
# Microservices Deployments + Services
# --------------------------------------------------------

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: user-service
  template:
    metadata:
      labels:
        app: user-service
    spec:
      containers:
      - name: user-service
        image: hospital-management-system-user-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8081
        env:
        - name: PORT
          value: "8081"
        - name: DATABASE_URL
          value: "postgres://hms:hms123@postgres-users:5432/users_db?sslmode=disable"
        readinessProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 3
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: user-service
spec:
  selector:
    app: user-service
  ports:
  - protocol: TCP
    port: 8081
    targetPort: 8081
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: doctor-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: doctor-service
  template:
    metadata:
      labels:
        app: doctor-service
    spec:
      containers:
      - name: doctor-service
        image: hospital-management-system-doctor-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8085
        env:
        - name: PORT
          value: "8085"
        - name: DATABASE_URL
          value: "postgres://hms:hms123@postgres-doctors:5432/doctors_db?sslmode=disable"
        readinessProbe:
          httpGet:
            path: /health
            port: 8085
          initialDelaySeconds: 3
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: doctor-service
spec:
  selector:
    app: doctor-service
  ports:
  - protocol: TCP
    port: 8085
    targetPort: 8085
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: notification-service
  template:
    metadata:
      labels:
        app: notification-service
    spec:
      containers:
      - name: notification-service
        image: hospital-management-system-notification-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8084
        env:
        - name: PORT
          value: "8084"
        readinessProbe:
          httpGet:
            path: /health
            port: 8084
          initialDelaySeconds: 3
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: notification-service
spec:
  selector:
    app: notification-service
  ports:
  - protocol: TCP
    port: 8084
    targetPort: 8084
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: billing-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: billing-service
  template:
    metadata:
      labels:
        app: billing-service
    spec:
      containers:
      - name: billing-service
        image: hospital-management-system-billing-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8083
        env:
        - name: PORT
          value: "8083"
        - name: DATABASE_URL
          value: "postgres://hms:hms123@postgres-billing:5432/billing_db?sslmode=disable"
        - name: APPOINTMENT_SERVICE_URL
          value: "http://appointment-service:8082"
        - name: USER_SERVICE_URL
          value: "http://user-service:8081"
        - name: NOTIFICATION_URL
          value: "http://notification-service:8084"
        readinessProbe:
          httpGet:
            path: /health
            port: 8083
          initialDelaySeconds: 3
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: billing-service
spec:
  selector:
    app: billing-service
  ports:
  - protocol: TCP
    port: 8083
    targetPort: 8083
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: appointment-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: appointment-service
  template:
    metadata:
      labels:
        app: appointment-service
    spec:
      containers:
      - name: appointment-service
        image: hospital-management-system-appointment-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8082
        env:
        - name: PORT
          value: "8082"
        - name: DATABASE_URL
          value: "postgres://hms:hms123@postgres-appointments:5432/appointments_db?sslmode=disable"
        - name: USER_SERVICE_URL
          value: "http://user-service:8081"
        - name: DOCTOR_SERVICE_URL
          value: "http://doctor-service:8085"
        - name: BILLING_SERVICE_URL
          value: "http://billing-service:8083"
        - name: NOTIFICATION_SERVICE_URL
          value: "http://notification-service:8084"
        readinessProbe:
          httpGet:
            path: /health
            port: 8082
          initialDelaySeconds: 3
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: appointment-service
spec:
  selector:
    app: appointment-service
  ports:
  - protocol: TCP
    port: 8082
    targetPort: 8082
  type: ClusterIP

---
# Prescription Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prescription-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prescription-service
  template:
    metadata:
      labels:
        app: prescription-service
    spec:
      containers:
      - name: prescription-service
        image: hospital/prescription-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8087
        env:
        - name: PORT
          value: "8087"
        - name: DATABASE_URL
          value: "postgres://hms:hms123@postgres-appointments:5432/appointments_db?sslmode=disable"
        - name: APPOINTMENT_SERVICE_URL
          value: "http://appointment-service:8082"
        - name: USER_SERVICE_URL
          value: "http://user-service:8081"
        readinessProbe:
          httpGet:
            path: /health
            port: 8087
          initialDelaySeconds: 3
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: prescription-service
spec:
  selector:
    app: prescription-service
  ports:
  - protocol: TCP
    port: 8087
    targetPort: 8087
  type: ClusterIP

---
# Payment Service (optional)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: payment-service
  template:
    metadata:
      labels:
        app: payment-service
    spec:
      containers:
      - name: payment-service
        image: hospital/payment-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8088
        env:
        - name: PORT
          value: "8088"
        - name: DATABASE_URL
          value: "postgres://hms:hms123@postgres-billing:5432/billing_db?sslmode=disable"
        readinessProbe:
          httpGet:
            path: /health
            port: 8088
          initialDelaySeconds: 3
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: payment-service
spec:
  selector:
    app: payment-service
  ports:
  - protocol: TCP
    port: 8088
    targetPort: 8088
  type: ClusterIP

# --------------------------------------------------------
# Optional: Expose some services via NodePort for local testing
# (You can also use "minikube service <svc>" to open)
# --------------------------------------------------------
---
apiVersion: v1
kind: Service
metadata:
  name: appointment-nodeport
spec:
  type: NodePort
  selector:
    app: appointment-service
  ports:
  - port: 8082
    targetPort: 8082
    nodePort: 30082
---
apiVersion: v1
kind: Service
metadata:
  name: user-nodeport
spec:
  type: NodePort
  selector:
    app: user-service
  ports:
  - port: 8081
    targetPort: 8081
    nodePort: 30081
---
apiVersion: v1
kind: Service
metadata:
  name: doctor-nodeport
spec:
  type: NodePort
  selector:
    app: doctor-service
  ports:
  - port: 8085
    targetPort: 8085
    nodePort: 30085
---
apiVersion: v1
kind: Service
metadata:
  name: billing-nodeport
spec:
  type: NodePort
  selector:
    app: billing-service
  ports:
  - port: 8083
    targetPort: 8083
    nodePort: 30083
---
apiVersion: v1
kind: Service
metadata:
  name: notification-nodeport
spec:
  type: NodePort
  selector:
    app: notification-service
  ports:
  - port: 8084
    targetPort: 8084
    nodePort: 30084
